# pet.py 重构实施计划

## 概述

本文档详细说明如何解构和分离 `src/frontend/pet.py` 中繁复的职责，基于 `docs/LIVE2D_REFACTORING_PLAN.md` 的架构设计。

**创建日期：** 2026-01-09  
**状态：** 准备中

---

## 一、当前问题分析

### 1.1 pet.py 的职责清单

当前 `src/frontend/pet.py` (约 600+ 行) 承担了以下职责：

| 职责 | 代码行数（估算） | 耦合度 | 优先级 |
|------|------------------|--------|--------|
| UI 初始化 (init_ui) | ~100 行 | 高 | P0 |
| 托盘图标管理 (init_tray_icon) | ~50 行 | 中 | P1 |
| 气泡系统集成 | ~80 行 | 高 | P0 |
| 截图功能 | ~60 行 | 中 | P1 |
| 移动管理 (MoveWorker 线程) | ~100 行 | 中 | P1 |
| 交互事件处理 | ~120 行 | 高 | P0 |
| 动画渲染（静态图片） | ~90 行 | 高 | P0 |

### 1.2 核心问题

1. **单一职责原则违反** - 一个类承担了过多职责
2. **动画渲染架构僵化** - 无法支持 Live2D 等动态动画
3. **子窗口管理混乱** - 强耦合，难以测试
4. **事件处理缺乏分层** - 逻辑与 UI 混合

---

## 二、重构目标

### 2.1 架构目标

将 `pet.py` 按照分层架构重构为：

```
src/frontend/
├── presentation/            # UI 层
│   ├── desktop_pet.py      # 简化后的主窗口
│   ├── bubble_system.py    # 气泡系统
│   └── tray_manager.py     # 托盘管理
├── core/                    # 核心业务层
│   ├── managers/           # 管理器
│   │   ├── render_manager.py    # 渲染管理
│   │   ├── event_manager.py     # 事件管理
│   │   └── state_manager.py    # 状态管理
│   └── render/             # 渲染器
│       ├── interfaces.py        # 渲染器接口
│       ├── static_renderer.py  # 静态渲染器
│       └── live2d_renderer.py  # Live2D 渲染器
└── components/             # 现有组件（保持不变）
    ├── bubble_menu.py
    ├── bubble_input.py
    └── bubble_speech.py
```

### 2.2 设计原则

1. **单一职责** - 每个类只负责一个功能
2. **依赖倒置** - 高层模块不依赖低层模块
3. **开闭原则** - 对扩展开放，对修改关闭
4. **接口隔离** - 使用接口定义行为契约

---

## 三、重构实施计划

### 阶段 1：准备工作 (1-2 天)

#### 目标
- 创建新的目录结构
- 准备基础框架
- 确保现有功能正常

#### 任务清单

##### 1.1 目录结构创建
- [ ] 创建 `src/frontend/presentation/` 目录
- [ ] 创建 `src/frontend/core/` 目录
- [ ] 创建 `src/frontend/core/managers/` 目录
- [ ] 创建 `src/frontend/core/render/` 目录
- [ ] 创建 `config/` 目录（已完成）
- [ ] 验证目录结构正确性

##### 1.2 配置系统完善
- [x] 创建 `config/__init__.py`
- [x] 创建 `config/loader.py`
- [x] 创建 `config/schema.py`
- [x] 创建配置模板 `config/templates/config.toml.template`
- [x] 删除旧的 `config.py` 文件
- [x] 更新所有导入语句
- [x] 测试配置加载功能

##### 1.3 接口定义
- [ ] 创建 `src/frontend/core/render/interfaces.py`
  - [ ] 定义 `IRenderer` 接口
  - [ ] 定义渲染器必需的方法
  - [ ] 添加类型注解和文档字符串

##### 1.4 测试框架准备
- [ ] 创建 `tests/` 目录结构
- [ ] 配置 pytest
- [ ] 编写配置加载测试
- [ ] 编写接口定义测试

#### 验收标准
- [ ] 目录结构完整
- [ ] 配置系统正常工作
- [ ] 所有现有功能正常运行
- [ ] 单元测试框架就绪

---

### 阶段 2：核心架构搭建 (3-5 天)

#### 目标
- 实现核心管理器
- 实现渲染器接口
- 重构主窗口

#### 任务清单

##### 2.1 渲染器接口实现
- [ ] 实现 `IRenderer` 接口
  ```python
  class IRenderer(ABC):
      @abstractmethod
      def initialize(self): pass
      
      @abstractmethod
      def attach(self, parent: QWidget): pass
      
      @abstractmethod
      def cleanup(self): pass
      
      @abstractmethod
      def set_animation_state(self, state: str): pass
      
      @abstractmethod
      def set_expression(self, expression: str): pass
      
      @abstractmethod
      def on_mouse_move(self, x: float, y: float): pass
  ```

##### 2.2 静态渲染器实现
- [ ] 创建 `src/frontend/core/render/static_renderer.py`
- [ ] 实现 `StaticRenderer` 类
- [ ] 实现图片加载和显示
- [ ] 实现缩放功能
- [ ] 编写单元测试

##### 2.3 渲染管理器实现
- [ ] 创建 `src/frontend/core/managers/render_manager.py`
- [ ] 实现 `RenderManager` 类
  - [ ] 加载渲染配置
  - [ ] 创建渲染器工厂
  - [ ] 实现模式切换逻辑
  - [ ] 实现渲染事件协调
- [ ] 编写单元测试

##### 2.4 事件管理器实现
- [ ] 创建 `src/frontend/core/managers/event_manager.py`
- [ ] 实现 `EventManager` 类
  - [ ] 处理鼠标事件
  - [ ] 处理键盘事件
  - [ ] 处理窗口事件
  - [ ] 实现右键菜单
  - [ ] 管理移动工作线程
- [ ] 编写单元测试

##### 2.5 状态管理器实现
- [ ] 创建 `src/frontend/core/managers/state_manager.py`
- [ ] 实现 `StateManager` 类
  - [ ] 管理窗口锁定状态
  - [ ] 管理窗口显示状态
  - [ ] 管理终端显示状态
  - [ ] 实现状态持久化
- [ ] 编写单元测试

##### 2.6 气泡系统重构
- [ ] 创建 `src/frontend/presentation/bubble_system.py`
- [ ] 实现 `BubbleSystem` 类
  - [ ] 封装 `SpeechBubbleList`
  - [ ] 封装 `BubbleInput`
  - [ ] 实现气泡位置更新
  - [ ] 实现消息显示接口
- [ ] 编写单元测试

##### 2.7 托盘管理器重构
- [ ] 创建 `src/frontend/presentation/tray_manager.py`
- [ ] 实现 `TrayManager` 类
  - [ ] 封装托盘图标管理
  - [ ] 封装托盘菜单创建
  - [ ] 实现显示/隐藏控制
- [ ] 编写单元测试

##### 2.8 主窗口重构
- [ ] 重构 `src/frontend/pet.py` 为简化版本
  - [ ] 保留窗口生命周期管理
  - [ ] 保留子窗口容器管理
  - [ ] 移除业务逻辑到管理器
  - [ ] 实现事件委托
- [ ] 保留 `src/frontend/pet.py` 作为备份
- [ ] 创建 `src/frontend/presentation/desktop_pet.py`
- [ ] 编写集成测试

#### 验收标准
- [ ] 静态图片模式正常工作
- [ ] 所有现有功能正常运行
- [ ] 单元测试通过率 > 80%
- [ ] 代码注释完整
- [ ] 文档更新完成

---

### 阶段 3：Live2D 集成 (5-10 天)

#### 目标
- 实现 Live2D 渲染器
- 实现 Live2D 模型加载
- 实现交互功能

#### 任务清单

##### 3.1 Live2D 环境准备
- [ ] 安装 Live2D 依赖
  ```bash
  pip install live2d-py
  ```
- [ ] 准备测试模型
- [ ] 创建模型目录结构
  ```
  live2d/
  └── models/
      └── test_model/
          ├── test_model.moc3
          ├── test_model.model3.json
          ├── textures/
          ├── motions/
          └── expressions/
  ```

##### 3.2 Live2D 渲染器实现
- [ ] 创建 `src/frontend/core/render/live2d_renderer.py`
- [ ] 实现 `Live2DRenderer` 类
  - [ ] 实现 OpenGL 上下文管理
  - [ ] 实现模型加载
  - [ ] 实现动作播放
  - [ ] 实现表情切换
  - [ ] 实现鼠标追踪
  - [ ] 实现物理模拟
- [ ] 编写单元测试

##### 3.3 Live2D 模型管理器
- [ ] 创建 `src/frontend/core/models/live2d_model.py`
- [ ] 实现 `Live2DModel` 类
  - [ ] 实现模型加载
  - [ ] 实现动作管理
  - [ ] 实现表情管理
  - [ ] 实现资源缓存
- [ ] 编写单元测试

##### 3.4 交互功能实现
- [ ] 实现鼠标追踪（注视效果）
- [ ] 实现点击反馈（物理效果）
- [ ] 实现状态切换（idle, happy, sad 等）
- [ ] 实现动作播放
- [ ] 实现表情切换

##### 3.5 性能优化
- [ ] 实现帧率控制
- [ ] 实现视锥体剔除
- [ ] 实现资源预加载
- [ ] 实现纹理缓存
- [ ] 实现 LOD（Level of Detail）

##### 3.6 集成测试
- [ ] 编写 Live2D 初始化测试
- [ ] 编写动画切换测试
- [ ] 编写鼠标追踪测试
- [ ] 编写性能测试

#### 验收标准
- [ ] Live2D 模型正常加载
- [ ] 动作和表情切换流畅
- [ ] 交互响应及时
- [ ] CPU 占用 < 20%
- [ ] 帧率稳定在 60 FPS
- [ ] 集成测试全部通过

---

### 阶段 4：功能完善 (3-5 天)

#### 目标
- 完善所有功能
- 优化用户体验
- 修复 Bug

#### 任务清单

##### 4.1 渲染模式切换
- [ ] 实现运行时模式切换
  - [ ] 静态 → Live2D
  - [ ] Live2D → 静态
- [ ] 实现切换动画
- [ ] 实现配置持久化
- [ ] 编写测试

##### 4.2 模型热切换
- [ ] 实现模型加载列表
- [ ] 实现模型预览
- [ ] 实现模型切换
- [ ] 实现模型缓存管理
- [ ] 编写测试

##### 4.3 窗口移动优化
- [ ] 优化移动工作线程
- [ ] 实现平滑移动
- [ ] 实现边界检测
- [ ] 实现多显示器支持
- [ ] 编写测试

##### 4.4 气泡系统优化
- [ ] 优化气泡位置计算
- [ ] 实现气泡动画
- [ ] 实现气泡样式自定义
- [ ] 优化性能
- [ ] 编写测试

##### 4.5 配置界面
- [ ] 创建配置编辑器
  - [ ] 渲染设置
  - [ ] Live2D 设置
  - [ ] 界面设置
  - [ ] 性能设置
- [ ] 实现配置导入/导出
- [ ] 实现配置验证
- [ ] 编写测试

##### 4.6 文档完善
- [ ] 更新用户文档
- [ ] 更新 API 文档
- [ ] 更新开发文档
- [ ] 编写迁移指南
- [ ] 编写 FAQ

##### 4.7 Bug 修复
- [ ] 收集和分类 Bug
- [ ] 优先级排序
- [ ] 逐个修复
- [ ] 回归测试

#### 验收标准
- [ ] 所有功能正常工作
- [ ] 用户体验良好
- [ ] 文档完整
- [ ] 无已知严重 Bug

---

### 阶段 5：测试和发布 (2-3 天)

#### 目标
- 全面测试
- 修复所有 Bug
- 发布新版本

#### 任务清单

##### 5.1 功能测试
- [ ] 启动测试
- [ ] 基本功能测试
  - [ ] 拖动窗口
  - [ ] 双击互动
  - [ ] 右键菜单
  - [ ] 聊天输入
  - [ ] 截图功能
- [ ] Live2D 功能测试
  - [ ] 模型加载
  - [ ] 动画切换
  - [ ] 表情切换
  - [ ] 鼠标追踪
  - [ ] 物理效果
- [ ] 模式切换测试
- [ ] 性能测试
  - [ ] 长时间运行（1小时）
  - [ ] 频繁切换动画
  - [ ] 多任务场景

##### 5.2 性能测试
- [ ] CPU 占用测试
- [ ] 内存占用测试
- [ ] 帧率测试
- [ ] 响应时间测试
- [ ] 生成性能报告

##### 5.3 兼容性测试
- [ ] Windows 10 测试
- [ ] Windows 11 测试
- [ ] 不同分辨率测试
- [ ] 不同缩放倍率测试
- [ ] 生成兼容性报告

##### 5.4 发布准备
- [ ] 更新 CHANGELOG
- [ ] 更新版本号
- [ ] 创建发布标签
- [ ] 编写发布说明
- [ ] 准备发布包

##### 5.5 发布
- [ ] 发布到 GitHub
- [ ] 发布到 PyPI（可选）
- [ ] 发送公告
- [ ] 收集用户反馈

#### 验收标准
- [ ] 所有测试通过
- [ ] 无严重 Bug
- [ ] 性能指标达标
- [ ] 文档完整
- [ ] 发布成功

---

## 四、风险管理

### 高风险项

| 风险项 | 影响 | 概率 | 应对措施 | 责任人 | 状态 |
|--------|------|------|----------|--------|------|
| Live2D 库不稳定 | 高 | 中 | 准备备用方案（使用官方 SDK） | 待定 | 未开始 |
| 性能问题 | 高 | 中 | 提前进行性能测试，优化渲染逻辑 | 待定 | 未开始 |
| 现有功能破坏 | 高 | 低 | 完善的单元测试，逐步迁移 | 待定 | 未开始 |
| 模型资源缺失 | 中 | 中 | 提供默认模型，支持自定义路径 | 待定 | 未开始 |

### 中风险项

| 风险项 | 影响 | 概率 | 应对措施 | 责任人 | 状态 |
|--------|------|------|----------|--------|------|
| 兼容性问题 | 中 | 中 | 在多个平台测试 | 待定 | 未开始 |
| 用户学习成本 | 中 | 低 | 提供详细文档和教程 | 待定 | 未开始 |
| 开发周期延长 | 中 | 中 | 严格执行阶段计划 | 待定 | 未开始 |

---

## 五、回滚策略

### 触发条件
- 阶段 3（Live2D 集成）无法按时完成
- 发现重大设计缺陷
- 性能无法满足要求

### 回滚步骤
1. 保留阶段 1 和阶段 2 的成果
2. 回退到静态图片模式
3. 修复因重构引入的问题
4. 发布基于新架构的静态版本

---

## 六、时间估算

| 阶段 | 预计时间 | 缓冲时间 | 最短时间 | 最长时间 |
|------|----------|----------|----------|----------|
| 阶段 1：准备工作 | 1-2 天 | 1 天 | 1 天 | 3 天 |
| 阶段 2：核心架构搭建 | 3-5 天 | 2 天 | 3 天 | 7 天 |
| 阶段 3：Live2D 集成 | 5-10 天 | 3 天 | 5 天 | 13 天 |
| 阶段 4：功能完善 | 3-5 天 | 2 天 | 3 天 | 7 天 |
| 阶段 5：测试和发布 | 2-3 天 | 1 天 | 2 天 | 4 天 |
| **总计** | **14-25 天** | **9 天** | **14 天** | **34 天** |

---

## 七、成功标准

### 技术指标
- [ ] 代码行数减少 30% 以上
- [ ] 单元测试覆盖率 > 80%
- [ ] CPU 占用 < 20%（Live2D 模式）
- [ ] 帧率稳定在 60 FPS
- [ ] 内存占用 < 200 MB
- [ ] 启动时间 < 3 秒

### 质量指标
- [ ] 代码符合 PEP 8 规范
- [ ] 所有函数都有文档字符串
- [ ] 关键模块有单元测试
- [ ] 无严重 Bug
- [ ] 性能指标达标

### 用户体验指标
- [ ] 启动流畅
- [ ] 交互响应及时
- [ ] 界面美观
- [ ] 功能完整
- [ ] 文档清晰

---

## 八、后续优化方向

### 短期优化（1-3 个月）
1. 性能优化
   - 多线程渲染
   - 资源预加载
   - 缓存优化
2. 功能完善
   - 多模型支持
   - 模型商店
   - 自定义动作
3. 用户体验
   - 配置界面
   - 快捷键自定义
   - 主题切换

### 中期优化（3-6 个月）
1. 高级功能
   - 语音识别
   - 语音合成
   - AI 对话
2. 多平台支持
   - macOS 支持
   - Linux 支持
   - Web 版本
3. 生态系统
   - 插件系统
   - 社区模型库
   - 开发者文档

### 长期优化（6-12 个月）
1. 技术升级
   - WebGL 渲染
   - VR/AR 支持
   - 云端渲染
2. 商业化
   - 付费模型
   - 订阅服务
   - 企业版本

---

## 九、参考资料

### 内部文档
- [Live2D 引入重构规划文档](./LIVE2D_REFACTORING_PLAN.md)
- [动态大小渲染功能文档](./f2-DYNAMIC_SIZE_RENDERING.md)
- [更新日志](./CHANGELOG.md)

### 外部资源
- [Live2D 官方文档](https://docs.live2d.com/)
- [PyQt5 官方文档](https://doc.qt.io/qt-5/)
- [Python 架构模式](https://refactoring.guru/design-patterns/python)
- [PEP 8 - Python 代码风格指南](https://pep.python.org/pep-0008/)

---

## 十、附录

### A. 术语表

| 术语 | 说明 |
|------|------|
| IRenderer | 渲染器接口，定义所有渲染器的通用行为 |
| RenderManager | 渲染管理器，负责创建和管理渲染器 |
| EventManager | 事件管理器，负责处理所有用户交互事件 |
| StateManager | 状态管理器，负责管理窗口状态 |
| Live2D | 一种 2D 动画技术，可以创建动态角色 |
| StaticRenderer | 静态图片渲染器，显示静态图片 |
| Live2DRenderer | Live2D 渲染器，显示 Live2D 动画 |

### B. 联系方式

如有问题或建议，请联系：
- 项目地址：https://github.com/MaiM-with-u/MaiM-desktop-pet
- 问题反馈：https://github.com/MaiM-with-u/MaiM-desktop-pet/issues

---

**文档结束**