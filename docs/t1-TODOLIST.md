# 重构任务清单

## 文档概述

本文档详细记录了 MaiM-desktop-pet 项目重构的所有任务清单。

**创建日期：** 2026-01-08  
**最后更新：** 2026-01-08

---

## 阶段 1：准备工作 ✅ 已完成

### 目标
- 创建新的目录结构
- 准备基础框架
- 确保现有功能正常

### 任务清单

- [x] 创建新的目录结构
  - [x] `src/frontend/core/` - 核心业务层
    - [x] `src/frontend/core/render/` - 渲染器模块
    - [x] `src/frontend/core/managers/` - 管理器模块
    - [x] `src/frontend/core/models/` - 模型模块
    - [x] `src/frontend/core/workers/` - 工作线程模块
  - [x] `src/frontend/presentation/` - UI 层
  - [x] `src/frontend/data/` - 数据层

- [x] 创建接口定义文件
  - [x] `src/frontend/core/render/interfaces.py` - 渲染器接口

- [x] 准备配置文件模板
  - [x] 更新 `config.toml` 添加 Live2D 相关配置
  - [x] 添加 `[render]` 配置段
  - [x] 添加 `[live2d]` 配置段
  - [x] 添加 `[animation]` 配置段
  - [x] 添加 `[performance]` 配置段

- [x] 备份现有代码
  - [x] 备份 `src/frontend/pet.py` → `src/frontend/pet.py.backup`
  - [x] 备份 `config.toml` → `config.toml.backup`

### 产出
```
src/frontend/
├── core/                    # 核心业务层 ✅
│   ├── render/              # 渲染器模块 ✅
│   │   ├── __init__.py
│   │   └── interfaces.py    # 渲染器接口 ✅
│   ├── managers/            # 管理器模块 ✅
│   │   └── __init__.py
│   ├── models/              # 模型模块 ✅
│   │   └── __init__.py
│   └── workers/             # 工作线程模块 ✅
│       └── __init__.py
├── presentation/            # UI 层 ✅
│   └── __init__.py
└── data/                    # 数据层 ✅
    └── __init__.py
```

---

## 阶段 2：核心架构搭建 ✅ 已完成

### 目标
- 实现核心管理器
- 实现渲染器接口
- 重构主窗口

### 任务清单

#### 2.1 渲染器实现
- [x] 实现静态图片渲染器
  - [x] 创建 `src/frontend/core/render/static_renderer.py`
  - [x] 实现 `initialize()` 方法
  - [x] 实现 `attach()` 方法
  - [x] 实现 `cleanup()` 方法
  - [x] 实现 `set_animation_state()` 方法（空实现或警告）
  - [x] 实现 `set_expression()` 方法（空实现或警告）
  - [x] 实现 `on_mouse_move()` 方法（空实现）
  - [x] 支持图片缩放
  - [ ] 支持图片缓存（待优化）

- [x] 实现 Live2D 渲染器框架
  - [x] 创建 `src/frontend/core/render/live2d_renderer.py`
  - [x] 实现 `initialize()` 方法框架
  - [x] 实现 `attach()` 方法框架
  - [x] 实现 `cleanup()` 方法框架
  - [x] 实现 `set_animation_state()` 方法框架
  - [x] 实现 `set_expression()` 方法框架
  - [x] 实现 `on_mouse_move()` 方法框架
  - [x] 添加 Live2D 库检测逻辑
  - [x] 添加优雅降级机制（Live2D 不可用时使用静态渲染）

#### 2.2 管理器实现
- [x] 实现渲染管理器
  - [x] 创建 `src/frontend/core/managers/render_manager.py`
  - [x] 实现渲染器创建逻辑
  - [x] 实现渲染模式切换
  - [x] 实现动画状态设置
  - [x] 实现表情设置
  - [x] 实现鼠标移动处理
  - [x] 添加配置加载功能
  - [x] 添加错误处理

- [x] 实现事件管理器
  - [x] 创建 `src/frontend/core/managers/event_manager.py`
  - [x] 实现鼠标按下处理
  - [x] 实现鼠标释放处理
  - [x] 实现鼠标移动处理
  - [x] 实现鼠标双击处理
  - [x] 实现右键菜单显示
  - [x] 实现窗口移动管理
  - [x] 迁移 `MoveWorker` 线程

- [x] 实现状态管理器
  - [x] 创建 `src/frontend/core/managers/state_manager.py`
  - [x] 实现窗口锁定/解锁
  - [x] 实现窗口显示/隐藏
  - [x] 实现终端显示/隐藏
  - [ ] 实现状态持久化（待修复）
  - [x] 实现状态通知机制

- [x] 实现气泡管理器
  - [x] 创建 `BubbleManager` 类（在 presentation 层）
  - [x] 整合 `SpeechBubbleList`
  - [x] 整合 `BubbleInput`
  - [x] 实现气泡位置同步
  - [x] 实现气泡显示/隐藏
  - [ ] 订阅窗口位置变化事件（待测试）

- [x] 实现截图管理器
  - [x] 创建 `ScreenshotManager` 类（在 presentation 层）
  - [x] 整合 `ScreenshotSelector`
  - [x] 实现截图功能
  - [x] 实现快捷键处理

#### 2.3 窗口重构
- [x] 创建简化版主窗口
  - [x] 创建 `src/frontend/presentation/refactored_pet.py`
  - [x] 实现窗口初始化
  - [x] 实现依赖注入
  - [x] 实现事件委托
  - [x] 实现子系统初始化
  - [x] 实现渲染容器

- [x] 迁移窗口管理逻辑
  - [x] 迁移窗口属性设置
  - [x] 迁移窗口标志设置
  - [x] 迁移窗口大小设置
  - [x] 迁移透明背景设置

#### 2.4 测试
- [x] 修改 main.py 以兼容新架构
- [x] 修复导入错误
- [x] 程序可以启动
- [x] 修复所有使用 type 参数的地方
- [x] 修复 BubbleManager 初始化问题
- [ ] 编写渲染器单元测试（待补充）
- [ ] 编写管理器单元测试（待补充）
- [ ] 编写集成测试（待补充）

### 验收标准
- [x] 静态图片模式正常工作
- [x] 所有现有功能正常运行
- [ ] 单元测试通过率 > 80%（待补充测试）
- [x] 集成测试通过（基本功能验证通过）

---

## 阶段 3：Live2D 集成 📋 待开始

### 目标
- 实现 Live2D 渲染器
- 实现 Live2D 模型加载
- 实现交互功能

### 任务清单

#### 3.1 Live2D 渲染器
- [ ] 安装 Live2D 库
  - [ ] 调研可用的 Live2D Python 库
  - [ ] 选择合适的库（live2d-py 或其他）
  - [ ] 添加到 `requirements.txt`
  - [ ] 编写安装文档

- [ ] 实现 Live2D 渲染器核心功能
  - [ ] 实现 Live2D 模型加载
  - [ ] 实现 Live2D 模型渲染
  - [ ] 实现 60FPS 渲染循环
  - [ ] 实现动作播放
  - [ ] 实现表情切换
  - [ ] 实现鼠标追踪（注视效果）
  - [ ] 实现物理模拟

- [ ] 优化 Live2D 渲染
  - [ ] 实现帧率控制
  - [ ] 实现视锥体剔除
  - [ ] 实现资源缓存
  - [ ] 实现 GPU 加速

#### 3.2 Live2D 模型管理
- [ ] 实现 Live2D 模型加载器
  - [ ] 创建 `src/frontend/core/models/live2d_model.py`
  - [ ] 实现 .model3.json 解析
  - [ ] 实现 .moc3 文件加载
  - [ ] 实现纹理加载
  - [ ] 实现动作加载
  - [ ] 实现表情加载
  - [ ] 实现物理加载

- [ ] 实现动作管理器
  - [ ] 创建 `src/frontend/core/models/motion_manager.py`
  - [ ] 实现动作队列
  - [ ] 实现动作优先级
  - [ ] 实现动作过渡

- [ ] 实现表情管理器
  - [ ] 创建 `src/frontend/core/models/expression_manager.py`
  - [ ] 实现表情切换
  - [ ] 实现表情过渡

#### 3.3 交互功能
- [ ] 实现鼠标追踪
  - [ ] 实现注视效果
  - [ ] 实现身体角度调整
  - [ ] 实现眼睛跟随

- [ ] 实现点击反馈
  - [ ] 实现点击检测
  - [ ] 实现物理效果
  - [ ] 实现动画触发

- [ ] 实现状态切换
  - [ ] 实现 idle 状态
  - [ ] 实现 talking 状态
  - [ ] 实现 happy 状态
  - [ ] 实现 sad 状态
  - [ ] 实现状态机

#### 3.4 测试
- [ ] 编写 Live2D 单元测试
  - [ ] 测试模型加载
  - [ ] 测试动作播放
  - [ ] 测试表情切换
  - [ ] 测试鼠标追踪

- [ ] 编写 Live2D 集成测试
  - [ ] 测试 Live2D 初始化
  - [ ] 测试动画切换
  - [ ] 测试交互响应
  - [ ] 测试模式切换

- [ ] 性能测试
  - [ ] 测试 CPU 占用率（目标 < 20%）
  - [ ] 测试内存占用
  - [ ] 测试帧率稳定性
  - [ ] 测试长时间运行

### 验收标准
- [ ] Live2D 模型正常加载
- [ ] 动作和表情切换流畅
- [ ] 交互响应及时
- [ ] CPU 占用 < 20%
- [ ] 帧率稳定在 60 FPS

---

## 阶段 4：功能完善 📋 待开始

### 目标
- 完善所有功能
- 优化用户体验
- 修复 Bug

### 任务清单

#### 4.1 渲染模式切换
- [ ] 实现运行时模式切换
  - [ ] 实现静态 → Live2D 切换
  - [ ] 实现 Live2D → 静态切换
  - [ ] 实现切换动画
  - [ ] 添加配置选项

#### 4.2 模型热切换
- [ ] 实现模型切换
  - [ ] 实现模型列表管理
  - [ ] 实现模型切换功能
  - [ ] 实现模型预览
  - [ ] 添加模型配置界面

#### 4.3 性能优化
- [ ] 优化窗口移动
  - [ ] 优化移动平滑度
  - [ ] 优化移动性能
  - [ ] 优化子窗口同步

- [ ] 优化气泡系统
  - [ ] 优化气泡渲染
  - [ ] 优化气泡动画
  - [ ] 优化气泡内存占用

#### 4.4 用户界面
- [ ] 添加配置界面
  - [ ] 创建设置窗口
  - [ ] 实现渲染模式设置
  - [ ] 实现模型设置
  - [ ] 实现性能设置
  - [ ] 实现快捷键设置

- [ ] 优化右键菜单
  - [ ] 添加模式切换选项
  - [ ] 添加模型切换选项
  - [ ] 添加设置入口

#### 4.5 文档
- [ ] 编写用户文档
  - [ ] 编写安装指南
  - [ ] 编写配置指南
  - [ ] 编写使用教程
  - [ ] 编写 Live2D 模型准备指南

- [ ] 编写开发文档
  - [ ] 编写架构文档
  - [ ] 编写 API 文档
  - [ ] 编写插件开发指南

### 验收标准
- [ ] 所有功能正常工作
- [ ] 用户体验良好
- [ ] 文档完整
- [ ] 性能指标达标

---

## 阶段 5：测试和发布 📋 待开始

### 目标
- 全面测试
- 修复所有 Bug
- 发布新版本

### 任务清单

#### 5.1 功能测试
- [ ] 完整的功能测试
  - [ ] 测试启动流程
  - [ ] 测试窗口操作
  - [ ] 测试聊天功能
  - [ ] 测试截图功能
  - [ ] 测试托盘功能
  - [ ] 测试所有快捷键

- [ ] Live2D 功能测试
  - [ ] 测试模型加载
  - [ ] 测试动画切换
  - [ ] 测试表情切换
  - [ ] 测试鼠标追踪
  - [ ] 测试物理效果
  - [ ] 测试模式切换

#### 5.2 性能测试
- [ ] 性能测试
  - [ ] 测试 CPU 占用率
  - [ ] 测试内存占用
  - [ ] 测试帧率稳定性
  - [ ] 测试启动时间
  - [ ] 测试响应时间

- [ ] 兼容性测试
  - [ ] 测试不同 Windows 版本
  - [ ] 测试不同分辨率
  - [ ] 测试不同 DPI 设置
  - [ ] 测试多显示器

#### 5.3 质量保证
- [ ] 修复已知 Bug
  - [ ] 修复功能 Bug
  - [ ] 修复性能 Bug
  - [ ] 修复兼容性 Bug
  - [ ] 修复安全 Bug

- [ ] 代码审查
  - [ ] 审查核心代码
  - [ ] 审查渲染代码
  - [ ] 审查管理器代码
  - [ ] 审查 UI 代码

#### 5.4 发布准备
- [ ] 更新 CHANGELOG
  - [ ] 记录新功能
  - [ ] 记录改进
  - [ ] 记录 Bug 修复
  - [ ] 记录破坏性变更

- [ ] 更新版本号
  - [ ] 更新 `config.py` 中的版本
  - [ ] 创建 Git 标签

- [ ] 发布新版本
  - [ ] 创建 Release
  - [ ] 上传安装包
  - [ ] 发布公告

### 验收标准
- [ ] 所有测试通过
- [ ] 无严重 Bug
- [ ] 性能指标达标
- [ ] 文档完整
- [ ] 成功发布

---

## 优先级说明

### P0 - 必须完成
- 阶段 2 的所有任务
- 核心管理器实现
- 静态渲染器实现
- 主窗口重构

### P1 - 重要
- 阶段 3 的所有任务
- Live2D 渲染器实现
- 模型管理
- 交互功能

### P2 - 一般
- 阶段 4 的一部分任务
- 配置界面
- 用户文档
- 性能优化

### P3 - 可选
- 阶段 4 的一部分任务
- 高级功能
- 详细文档
- 开发者文档

---

## 风险管理

### 高风险项
- [ ] Live2D 库不稳定
  - **应对措施**：准备备用方案（使用官方 SDK）
- [ ] 性能问题
  - **应对措施**：提前进行性能测试，优化渲染逻辑
- [ ] 现有功能破坏
  - **应对措施**：完善的单元测试，逐步迁移

### 中风险项
- [ ] 兼容性问题
  - **应对措施**：在多个平台测试
- [ ] 用户学习成本
  - **应对措施**：提供详细文档和教程
- [ ] 开发周期延长
  - **应对措施**：严格执行阶段计划

---

## 回滚策略

### 触发条件
- 阶段 3（Live2D 集成）无法按时完成
- 发现重大设计缺陷
- 性能无法满足要求

### 回滚步骤
1. 保留阶段 1 和阶段 2 的成果
2. 回退到静态图片模式
3. 修复因重构引入的问题
4. 发布基于新架构的静态版本

---

## 当前状态

### 最新进展
- ✅ 完成阶段 1（准备工作）
- ⏳ 正在进行阶段 2（核心架构搭建）

### 下一步行动
1. 实现 `StaticRenderer` 类
2. 实现 `RenderManager` 类
3. 实现 `EventManager` 类
4. 实现 `StateManager` 类
5. 重构主窗口

### 预计完成时间
- 阶段 2：预计 3-5 天
- 阶段 3：预计 5-10 天
- 阶段 4：预计 3-5 天
- 阶段 5：预计 2-3 天
- **总计：13-23 天**

---

## 附录

### A. 相关文档
- [LIVE2D_REFACTORING_PLAN.md](./LIVE2D_REFACTORING_PLAN.md) - 重构规划文档
- [CHANGELOG.md](./CHANGELOG.md) - 变更日志
- [README.md](../README.md) - 项目说明

### B. 参考资源
- [Live2D 官方文档](https://docs.live2d.com/)
- [PyQt5 官方文档](https://doc.qt.io/qt-5/)
- [Python 架构模式](https://refactoring.guru/design-patterns/python)

---

**文档结束**
